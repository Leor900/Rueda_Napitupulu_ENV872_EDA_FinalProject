---
title: "Is air pollution correlated to inter-state migration in the US"
author: "Leonardo Rueda & Theo Napitupulu"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
subtitle: EDA_Final_Project
geometry: margin=2.54cm
editor_options: null
chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=70), tidy=TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/leor9/OneDrive/Leonardo/MIDP Courses Fall 2022/R Class/Project/Rueda_Napitupulu_ENV872_EDA_FinalProject")

```

## OVERVIEW

This project looks at the effects of air pollution on inter-state migration in the United States using the Air Quality Index datasets from EPA (available at https://aqs.epa.gov/aqsweb/airdata/download_files.html) and the Population Migration data from the IRS (available at https://www.irs.gov/statistics/soi-tax-stats-migration-data) for the period 2012-2020. 

Evidence from middle-income countries shows that air pollution has negative impacts on several health and economic outcomes, such as mortality rates, health expenditures, mental health, hours worked, labor productivity and income.  Additionally, other studies have shown how migration decisions are affected by air pollution. For instance, Chen, S., Oliva, P., & Zhang, P. (2022) found that a 10 percent increase in air pollution, holding everything else constant, reduces population through net outmigration by about 2.8 percent in a given county in China (see Chen, S., Oliva, P., & Zhang, P. (2022). The effect of air pollution on migration: Evidence from China. Journal of Development Economics, 156, 102833. https://doi.org/10.1016/j.jdeveco.2022.102833) 

Our hypothesis is that there is a positive relationship between high air pollution and migration outflows, that is, the highest the pollution registered by the Air Quality Index (AQI) in a state in a given year, the higher the number of people leaving that state the same year. 

The Air Quality Index dataset provides annual information per county about the maximum values reached by the AQI, the number of days in which this index reached values considered unhealthy, and the number of days with PM2.5 particles recorded. The Air Quality Index dataset provides annual information at the State level about the number of people whose reported home address changed in their individual income tax returns. 

## Set up

* Get the working directory. 
* Upload the packages for the analysis. 
* Set the theme. 

```{r Getting the working directory and loading packages}

getwd()

library('dplyr')
library('plyr')
library('ggplot2')
library('tidyverse')
library('rvest')

mytheme <- theme_classic() +
  theme(axis.text = element_text(color = "black", angle = 90), 
        legend.position = "top", plot.title = element_text(hjust = 0.5, face = "bold"), plot.subtitle = element_text(hjust = 0.5))

theme_set(mytheme)

```

## Data Wrangling

**1. Air Quality Datasets**

* The raw AQI datasets are available by year. Therefore, we create a dataset with the information from 2010 to 2020. 
* This dataset is at the county level. We aggregate the information at the state level. Likewise, we calculate the state averages for the variables Unhealthy.Days, Max.AQI, and Days.PM2.5.  
* We save the new dataset in the data/processed folder. 


```{r AQI datasets wrangling}

# Air quality datasets 2010-2020

mydir = "./Data/Raw/Annual_aqi_by_county"
files = list.files(path = mydir, pattern = "*.csv", full.names = TRUE)
files
Annual_AQI_by_county_2010_2020 <- ldply(files, read.csv) 

# Dataset at the state level and averages for variables of interest 

Annual_AQI_by_state_2010_2020 <- Annual_AQI_by_county_2010_2020 %>% group_by(Year, State) %>% dplyr::summarise(Year=first(Year), Avg.Unhealthy.Days= mean(Unhealthy.Days), Avg.Max.AQI=mean(Max.AQI), Avg.Days.PM2.5=mean(Days.PM2.5))

# Saving the new AQI dataset with information at the state level from 2010 to 2020

write.csv(Annual_AQI_by_state_2010_2020, file = "./Data/Processed/Annual_AQI_by_state_2010_2020_Processed.csv", row.names=FALSE)

```

**2. Inter-state migration datasets**

* The Inter-state migration datasets do not include the variable "Year", so we create it. Then, we save each dataset in the folder Data/Raw. 
* We create a dataset with information from 2012 to 2020. 
* According to the dictionary for this dataset, the variable "y2_statefips" and the code "96" refers to the total outflows of migrants for each state in a given year. Therefore, we filtered the previous dataset by that value.
* We change this variable's name to "FIPS_Code", so later we can merge this dataset with the AQI dataset. 
* We save the dataset with migration outflows per state for years 2010-2020 in the folder Data/Processed. 


```{r Migration datasets wrangling}

# Creating the variable "Year" for each migration dataset

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1112.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2012) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1112.csv", row.names=FALSE) #2012

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1213.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2013) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1213.csv", row.names=FALSE) #2013

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1314.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2014) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1314.csv", row.names=FALSE) #2014

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1415.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2015) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1415.csv", row.names=FALSE) #2015

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1516.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2016) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1516.csv", row.names=FALSE) #2016

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1617.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2017) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1617.csv", row.names=FALSE) #2017

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1718.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2018) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1718.csv", row.names=FALSE) #2018

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1819.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2019) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1819.csv", row.names=FALSE) #2019

read.csv("./Data/Raw/Outflows_by_state/stateoutflow1920.csv",
stringsAsFactors = TRUE) %>% mutate(Year=2020) %>% write.csv(file = "./Data/Raw/Outflows_by_state/stateoutflow1920.csv", row.names=FALSE) #2020

# Merging the dataset for years 2012 - 2020

mydir = "./Data/Raw/Outflows_by_state"
files = list.files(path = mydir, pattern = "*.csv", full.names = TRUE)
files
Mig_outflows_by_state_2012_2020 <- ldply(files, read.csv) 

# Filtering by the variable "y2_statefips == 96" (total outflows by state)

Mig_outflows_by_state_2012_2020_filtered <- filter(Mig_outflows_by_state_2012_2020, y2_statefips == 96) 

# Changing the name of the variable with information of the code state

colnames(Mig_outflows_by_state_2012_2020_filtered)[1] = "FIPS_Code" 

#Saving the dataset with migration information 

write.csv(Mig_outflows_by_state_2012_2020_filtered, file = "./Data/Processed/Mig_outflows_by_state_2012_2020_Processed.csv", row.names=FALSE)

```

**3. Scraping the FIPS codes** 

* The AQI Dataset has the names of each State in the US, but it does not have the code, which is the variable we need to merge this data with the migration one. 
* In the object "the_website" we store the website direction where the FIPS codes are available (https://www.bls.gov/respondents/mwr/electronic-data-interchange/appendix-d-usps-state-abbreviations-and-fips-codes.htm). 
* We scrape from the website the information for the states and codes, and we create a data frame. 
* We merge this dataset with the AQI dataset by the variable "State".
* We save the dataset in the folder Data/Processed.  

```{r Scrapping the FIPS codes}

# Scrapping the FIPS Codes 

the_website <- read_html('https://www.bls.gov/respondents/mwr/electronic-data-interchange/appendix-d-usps-state-abbreviations-and-fips-codes.htm')

#Creating the variables for the states and codes 

the_states <- the_website %>% html_nodes("tr+ tr td:nth-child(4) , tr+ tr td:nth-child(1)") %>% html_text()
the_states

the_codes <- the_website %>% html_nodes("tr+ tr td:nth-child(6) , tr+ tr td:nth-child(3)") %>% html_text()
the_codes
df_states_codes <- data.frame("State" = the_states,
                             "FIPS_Code" = as.numeric(the_codes))

#Paste the state code to the air quality dataset 

Annual_AQI_by_state_2010_2020 <- merge(Annual_AQI_by_state_2010_2020, df_states_codes, by='State')

#Save the new dataset

write.csv(Annual_AQI_by_state_2010_2020, file = "./Data/Processed/Annual_AQI_by_state_2010_2020_Processed.csv", row.names=FALSE)


```

**4. Merging the AQI and Migration datasets**

* We merge and arrange the AQI and the migration datasets by the variables "FIPS_Code" and "Year". The resulting dataset has information from 2012 to 2020.
* According to the dictionary for the migration dataset, the variable "n2" refers to the number of individuals who migrated to other states. To facilitate the interpretation, we changed the name of the variable to "Migrants.outflows".
* We create a subset of the previous dataset with the variables of interest: FIPS_Code, Year, State, Avg.Unhealthy.DAys, Avg.Days.AQI, Avg.Days.PM2.5, and Migrants.outflows. 
* We save the dataset in the folder Data/Processed. This is the dataset that we will use in our analysis. 

```{r Merging the AQI and Migration Dataset}

# Paste air quality and migration data 

AQI_Mig.outflows_by.state_2012_2020 <- merge(Annual_AQI_by_state_2010_2020, Mig_outflows_by_state_2012_2020_filtered, by=c("FIPS_Code","Year"))

# Arranging the dataset in ascending order

AQI_Mig.outflows_by.state_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020 %>% arrange(Year, FIPS_Code)

# Changing the name of the variable with information of the code state

colnames(AQI_Mig.outflows_by.state_2012_2020)[11] = "Migrants.outflows" 

# Create a subset with the variables of interest for the analysis 

AQI_Mig.outflows_by.state_2012_2020 = subset(AQI_Mig.outflows_by.state_2012_2020, select = -c(y2_statefips, y2_state_name, n1, AGI))

# Save the final dataset for the analysis 

write.csv(AQI_Mig.outflows_by.state_2012_2020, file = "./Data/Processed/AQI_Mig.outflows_by.state_2012_2020.csv", row.names=FALSE)

```

**5.AQI and Migration by State 2012 and 2020**

```{r AQI and Migration by State 2012 and 2020}

# Average unhealthy days by State 2012-2020 

Unhealthy_days_by_state_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020 %>% ggplot(aes(x=State, y=Avg.Unhealthy.Days)) + geom_boxplot() + mytheme + ylab("Average Unhealthy Days") + ylim(0, 10) + labs(title = "Average Unhealthy Days by State", subtitle = "2012-2020")

Unhealthy_days_by_state_2012_2020

# Average max AQI value by State 2012-2020 

AQI_by_state_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020 %>% ggplot(aes(x=State, y=Avg.Max.AQI)) + geom_boxplot() + mytheme + ylab("Average Max AQI value") + ylim(80, 300) + labs(title = "Average max AQI value by State", subtitle = "2012-2020")

AQI_by_state_2012_2020

# Average days PM2.5 by State 2012-2020 

PM2.5_by_state_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020 %>% ggplot(aes(x=State, y=Avg.Days.PM2.5)) + geom_boxplot() + mytheme + ylab("Average days PM2.5") + labs(title = "Average days PM2.5 by State", subtitle = "2012-2020")

PM2.5_by_state_2012_2020

# CHECK: Migration outflows by State 2012-2020 (proportion of migrant outflows by State per year) 

# Table (proportion is multiplied by 100, so it is read like a percentage)

table_migration_by_state_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020  %>% group_by(Year) %>%  dplyr::summarise(Prop.Migrants.outflows=(Migrants.outflows/sum(Migrants.outflows))*100, Avg.Unhealthy.Days=Avg.Unhealthy.Days, State=State)

# Table for 2012

table_migration_by_state_2012_2020 %>% group_by(State, Year) %>% dplyr::summarise(min=min(Prop.Migrants.outflows), median=median(Prop.Migrants.outflows), mean=mean(Prop.Migrants.outflows), max=max(Prop.Migrants.outflows)) %>% filter(Year==2012) %>% arrange(desc(mean))

# Table for 2020

table_migration_by_state_2012_2020 %>% group_by(State, Year) %>% dplyr::summarise(min=min(Prop.Migrants.outflows), median=median(Prop.Migrants.outflows), mean=mean(Prop.Migrants.outflows), max=max(Prop.Migrants.outflows)) %>% filter(Year==2020) %>% arrange(desc(mean))


# Graph 

#graph_migration_by_state_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020  %>% group_by(Year) %>%  dplyr::summarise(Prop.Migrants.outflows=(Migrants.outflows/sum(Migrants.outflows))*100, Avg.Unhealthy.Days=Avg.Unhealthy.Days, State=State) %>% filter(Year==2020) %>% arrange(desc(Avg.Unhealthy.Days)) %>% ggplot(aes(x=State, y=Prop.Migrants.outflows)) + geom_boxplot() + mytheme 

#graph_migration_by_state_2012_2020

# CKECK Relationship between migration and air quality

migration_AQI_2012_2020 <- AQI_Mig.outflows_by.state_2012_2020 %>% ggplot(aes(x=Migrants.outflows, y=Avg.Unhealthy.Days)) + geom_point(aes(color= Year)) + mytheme + geom_smooth(method = "lm", se = FALSE, color = "black")

migration_AQI_2012_2020


```


**6. Correlations**


```{r Initial Correlations}
# Initial correlation tests

cor.test(AQI_Mig.outflows_by.state_2012_2020$Avg.Unhealthy.Days, AQI_Mig.outflows_by.state_2012_2020$Migrants.outflows)

cor.test(AQI_Mig.outflows_by.state_2012_2020$Avg.Max.AQI, AQI_Mig.outflows_by.state_2012_2020$Migrants.outflows)

cor.test(AQI_Mig.outflows_by.state_2012_2020$Avg.Days.PM2.5, AQI_Mig.outflows_by.state_2012_2020$Migrants.outflows)
```


